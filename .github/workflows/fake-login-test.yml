name: CI Login Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-fake-auth:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - uses: cachix/install-nix-action@v31
      
      - name: Build workspace with predictable outputs
        run: |
          nix build .#cli -o result-cli
          nix build .#backend -o result-backend
      
      - name: Start backend with fake auth
        run: |
          export ENABLE_FAKE_AUTH=1
          export JWT_SECRET=test-secret
          export PORT=8080
          
          result-backend/bin/steadystate-backend &
          BACKEND_PID=$!
          sleep 2 # Give the server a moment to start
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
      
      - name: Test fake login
        run: |
          export STEADYSTATE_BACKEND=http://localhost:8080
          result-cli/bin/steadystate login --provider fake
          
          # Check human-readable output
          result-cli/bin/steadystate whoami | grep "Logged in as: ci-test-user"

          # Check machine-readable output and verify login status
          result-cli/bin/steadystate whoami --json | jq -e '.logged_in == true'
          result-cli/bin/steadystate whoami --json | jq -e '.login == "ci-test-user"'
      
      - name: Cleanup Backend
        if: always()
        run: |
          echo "Stopping backend process (PID: $BACKEND_PID)..."
          kill $BACKEND_PID || true
